<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PacMan-socket.js | Francesco Cesari</title>
    <link rel="icon" href="/client/img/pacman.ico" type="image/icon-x" />
    <link rel="stylesheet" href="/client/css/style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.min.js"></script>
    <script src="/client/js/Character.js"></script>
    <script src="/client/js/Maze.js"></script>
    <script src="/client/js/PacMan.js"></script>
    <script src="/client/js/Ghost.js"></script>
  </head>
  <body>
    <div class="panel">
      <div class="panel-content">
        <span class="title">
          SELECT CHARACTER
        </span>
        <hr />
        <div class="select-character-content">
          <div class="character-content">
            <img src="/client/img/pacman_left.gif" />
            <button type="button" id="select-pacman">PACMAN</button>
          </div>
          <div class="character-content">
            <img src="/client//img/blinky.gif" />
            <button type="button" id="select-blinky">BLINKY</button>
          </div>
          <div class="character-content">
            <img src="/client/img/pinky.gif" />
            <button type="button" id="select-pinky">PINKY</button>
          </div>
        </div>
        <div class="wait-content">
          <span>Waiting for the other users</span>
          <img src="/client/img/loading.svg" />
        </div>
      </div>
    </div>
  </body>
  <script type="text/javascript">
    var myCharacter;
    var myCharcterName;
    var userCharacters = [];
    var maze;
    var start = false;
    const socket = io("/game");
    var url = new URL(document.location.href);
    const name = url.searchParams.get("name");
    const room = url.searchParams.get("room");

    document
      .getElementById("select-pacman")
      .addEventListener("click", () => selectCharacter("pacman"));

    document
      .getElementById("select-blinky")
      .addEventListener("click", () => selectCharacter("blinky"));

    document
      .getElementById("select-pinky")
      .addEventListener("click", () => selectCharacter("pinky"));

    function selectCharacter(character) {
      socket.emit("character", character, (error) => {
        if (error !== undefined) alert(error);
        else {
          document.querySelector(".wait-content").style.display = "block";
          myCharcterName = character;
        }
      });
    }

    socket.emit("join", { name, room }, (error) => {
      alert(error);
      location.href = "/";
    });

    socket.on("message", ({ user, text }) => {
      console.log(`${user}: ${text}`);
    });

    socket.on("start", (serverMaze) => {
      console.log("started");
      document.querySelector(".panel").remove();
      document.body.innerHTML +=
        "<div id='canv_parent'><span class='title'>PAC MAN</span><hr></div>";
      start = true;
      maze = new Maze(serverMaze);
      createCanvas(maze.width, maze.height).parent("canv_parent");
      noStroke();
      background("#201e00");
      maze.showWalls();
      maze.showPellets();
      var name = myCharcterName;
      if (name === "pacman") {
        myCharacter = new PacMan(
          13 * maze.tileWidth + maze.tileWidth / 2,
          26 * maze.tileHeight,
          maze.tileWidth + 5,
          maze.tileHeight + 5,
          maze,
          socket
        );
      } else if (name === "blinky") {
        myCharacter = new Ghost(
          13 * maze.tileWidth,
          17 * maze.tileHeight,
          maze.tileWidth,
          maze.tileHeight,
          maze,
          socket
        );
      } else if (name === "pinky") {
        myCharacter = new Ghost(
          14 * maze.tileWidth,
          17 * maze.tileHeight,
          maze.tileWidth,
          maze.tileHeight,
          maze,
          socket
        );
      }
      myCharacter.name = name;
      myCharacter.draw();
      myCharacter.update();
    });

    socket.on("eat", (data) => {
      maze.matrix[data.i][data.j].value = -1;
    });

    function drawCharacter(character) {
      if (character.name === "pacman") {
        var pacman = new PacMan(
          character.x,
          character.y,
          maze.tileWidth + 5,
          maze.tileHeight + 5,
          maze,
          socket
        );
        pacman.dir = character.dir;
        pacman.draw();
      } else if (character.name === "blinky") {
        var ghost = new Ghost(
          character.x,
          character.y,
          maze.tileWidth,
          maze.tileHeight,
          maze,
          socket
        );
        ghost.name = "blinky";
        ghost.draw();
      } else {
        var ghost = new Ghost(
          character.x,
          character.y,
          maze.tileWidth,
          maze.tileHeight,
          maze,
          socket
        );
        ghost.name = "pinky";
        ghost.draw();
      }
    }

    socket.on("position", (data) => {
      userCharacters[data.id] = data;
    });

    function draw() {
      if (start) {
        noStroke();
        background("#201e00");
        maze.showWalls();
        maze.showPellets();
        if (keyCode === LEFT_ARROW) {
          myCharacter.setDir(1);
        } else if (keyCode === RIGHT_ARROW) {
          myCharacter.setDir(3);
        } else if (keyCode === UP_ARROW) {
          myCharacter.setDir(2);
        } else if (keyCode === DOWN_ARROW) {
          myCharacter.setDir(4);
        }
        myCharacter.move();
        myCharacter.draw();
        for (i in userCharacters) {
          if (userCharacters[i] != undefined) {
            drawCharacter(userCharacters[i]);
          }
        }
        if (myCharacter.name === "pacman") {
          myCharacter.eat();
          //score += myCharacter.score;
          //document.getElementById("score").innerHTML = "SCORE: " + score;
        } /*else {
                  for (var i in characterToDraw) {
                    if (characterToDraw[i].characterName === "pacman") {
                      myCharacter.catch(characterToDraw[i]);
                    }
                  }
                }
              }

            }*/
      }
    }
  </script>
</html>
